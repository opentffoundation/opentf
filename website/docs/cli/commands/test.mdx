---
description: >-
    The tofu test command performs integration tests of OpenTofu modules.
---

# Command: test

The `tofu test` command runs integration tests to ensure intended behavior of your OpenTofu configuration. It creates real
infrastructure, asserts conditional checks against the attributes of provisioned resources and attempts
to clean up the testing infrastructure upon completion.

## Usage

Usage: `tofu test [options]`

The `test` command executes the automated integration tests defined in `.tftest.hcl` files which OpenTofu will read
from the current configuration and testing directories.

OpenTofu will create real infrastructure according to the definition in the tested configuration. Then, it will
sequentially run the test blocks to perform conditional checks and assertions against attributes of provisioned resources.
Upon tests completion, OpenTofu will attempt to clean up created resources.

_Note_: monitor the test output for successful cleanup.

## General Options

* `-test-directory=path` Set the test directory (default: "tests"). OpenTofu will search for test files in the set directory
as well as in the directly in which `tofu test` was executed.

:::warning
The path should be relative to the directory in which `tofu test` is called.
:::

* `-filter=testfile` Specify an individual test file to use for testing. The option can be used multiple times to specify several files.

:::warning
The path should be relative to the directory in which `tofu test` is called.
:::

* `-var 'foo=bar'` Set the input variables of the root module. The option can be used multiple times to set several variables.

* `-var-file=filename` Set the path to the file with variables values in addition to the default files terraform.tfvars and *.auto.tfvars.
The option can be used multiple times to specify several files.

* `-json` Set for test outputs to be formatted as JSON.

* `-no-color` Disable color codes in the command output.

* `-verbose` Print the plan or state for each test run block as it executes.

## Usage examples

### Flat structure

**GIVEN** the following OpenTofu module structure:

```commandline
.
├── LICENSE
├── README.md
├── main.tf
├── main.tftest.hcl
├── foo.tf
├── foo.tftest.hcl
├── bar.tf
├── bar.tftest.hcl
├── outputs.tf
└── variables.tf
```

**WHEN** `tofu test` is executed in the project directory,

**THEN** the tests defined in the following files will be run (note that the files are sorted in alphabetical order):

- bar.tftest.hcl,
- foo.tftest.hcl,
- main.tftest.hcl.

**WHEN** `tofu test -filter=foo.tftest.hcl -filter=bar.tftest.hcl` is executed in the project directory,

**THEN** the tests defined in the files `foo.tftest.hcl` and `bar.tftest.hcl` will be run only.

### Nested structure

**GIVEN** the following OpenTofu module structure:

```commandline
.
├── LICENSE
├── README.md
├── main.tf
├── main.tftest.hcl
├── outputs.tf
├── variables.tf
├── tests
│   └── foo.tftest.hcl
└── submodule
    ├── foo.tf
    ├── foo.tftest.hcl
    ├── main.tf
    ├── main.tftest.hcl
    ├── outputs.tf
    ├── variables.tf
    └── tests
        └── foo.tftest.hcl
```

**WHEN** `tofu test` is executed in the project root directory,

**THEN** the tests defined in the following files will be run (note that the files are sorted in alphabetical order):

- main.tftest.hcl,
- tests/foo.tftest.hcl.

**WHEN** `tofu test -test-directory=submodule` is executed in the project root directory,

**THEN** the tests defined in the following files will be run (note that the files are sorted in alphabetical order):

- main.tftest.hcl,
- submodule/foo.tftest.hcl,
- submodule/main.tftest.hcl.

**WHEN** `tofu test -test-directory=submodule -filter=foo.tftest.hcl` is executed in the project root directory,

**THEN** no tests will be run because no test files satisfying filtering criteria will be found.

**WHEN** `tofu test -test-directory=submodule -filter=submodule/foo.tftest.hcl` is executed in the project root directory,

**THEN** the tests defined in the file `submodule/foo.tftest.hcl` will be run only.

## Definition syntax

## idea1 - layers: start with a high level overview and zoom-in layer-by-layer

Tests are defined using three kinds of blocks in the way that every test file

- _shall_ contain _at least one_ `run` block to describe a single test operation;
- _may_ contain _at most one_ `variables` block to define global variables used by the `runs` defined in the file;
- _may_ contain _multiple_ `provider` blocks to define a provider configuration to be used by the test.

<!--
    /internal/command/testing/test_provider.go:
    provider:
        data_prefix: string
        resource_prefix: string
        alias: string
        version: string
    test_resource:
        id: string
        value: string
        interrupt_count: number
    test_data_source:
        id: string
        value: string
        interrupt_count: number
-->

### `run` block



```terraform
run "test-foo" {
  # (optional)
  command=plan

  plan_options={
    refresh=false
  }

  assert {
    condition = var.input == 12
    error_message = "something"
  }
}
```

Provider:
- alias
- version
- data_prefix
- resource_prefix


## idea2 - define the "testing language ABC": keywords and their hierarchy, and illustrate how to define tests in the end

|Keyword        | Type      | Description                                                                                                                        |
|:----------    |:----------|:-----------------------------------------------------------------------------------------------------------------------------------|
|`run`          | block     | The named block which defines a single test operation unit.                                                                        |
|`provider`     | block     | The named block which                                                                                                              |
|`variables`    | block     | Key-value object which defines variables used for test.                                                                            |
|`assert`       | block     | The block which defines the test condition.                                                                                        |
|`module`       | block     | specifies the module to execute the `run` block.                                                                                   |
|`plan_options` |           |                                                                                                                                    |
|`condition`    | [condition](/docs/language/expressions/conditionals#conditions) |                                                                                                                                    | Assertion criteria as a boolean expression.                                                            |
|`error_message`| string    | Assertion message.                                                                                                                 |
|`command`      | string           | Defines which command a given run block will execute, _plan_ or _apply_. Defaults to _apply_.                                      |
|`mode`         ||                                                                                                                                    |
|`providers`||                                                                                                                                    |
|`alias`|           |                                                                                                                                    |
|`data_prefix`      |     |                                                                                                                                    |
|`resource_prefix`           |                                                                                                        |                                                                                                                                    |
|`mode` | string  | Defines the plan mode that OpenTofu will use for a given run block, _normal_ or _refresh-only_. Defaults to _normal_.              |
|`target`|           |                                                                                                                                    |
|`hashes`|           |                                                                                                                                    |
|`version`|           |                                                                                                                                    |
|`expect_failures`| list(resourece| value)                                                                                                                             | Defines resources which are expected to fail during the test. It is useful to test unhappy path. |
|`refresh`|bool | Analog to the `tofu plan -refresh`                                                                                                            |

## Variables

Tests can be defined using variables specified in several ways.

The variables will be loaded in the following order, with later sources taking precedence over earlier ones:

1. Environment variables with the prefix `TF_VAR_`;
2. tfvar files specified: `terraform.tfvars` and `*.auto.tfvars`;
3. Commandline variables defined using the flag `-var`, and the variables defined in the files specified by the flag `-var-file`;
4. _Global_ variables from the `variables` block in test file;
5. _Local_ variables from the `variables` block in `run` block.

:::info
The variable value defined by the flags `-var` and `-var-file` will depend on their order: the latest found value will be used.

For example, **given** that the file `test.tfvars` contains the value `my_var="bar"`,
**when** `tofu test -var=my_var="foo" -var-file=test.tfvars -var=my_var="qux"` is executed,
**then** the variable `my_var` will be assigned the value `"qux"`.
:::

## Definition examples

TBD
