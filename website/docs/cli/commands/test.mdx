---
description: >-
    The tofu test command performs integration tests of OpenTofu modules.
---

# Command: test

The `tofu test` command runs integration tests to ensure intended behavior of your OpenTofu configuration. It creates real
infrastructure, asserts conditional checks against the attributes of provisioned resources and attempts
to clean up the testing infrastructure upon completion.

## Usage

Usage: `tofu test [options]`

The `test` command executes the automated integration tests defined in `.tftest.hcl` files which OpenTofu will read
from the current configuration and testing directories.

OpenTofu will create real infrastructure according to the definition in the tested configuration. Then, it will
sequentially run the test blocks to perform conditional checks and assertions against attributes of provisioned resources.
Upon tests completion, OpenTofu will attempt to clean up created resources.

_Note_: monitor the test output for successful cleanup.

## General Options

* `-test-directory=path` Set the test directory (default: "tests"). OpenTofu will search for test files in the set directory
as well as in the directly in which `tofu test` was executed.

:::warning
The path should be relative to the directory in which `tofu test` is called.
:::

* `-filter=testfile` Specify an individual test file to use for testing. The option can be used multiple times to specify several files.

:::warning
The path should be relative to the directory in which `tofu test` is called.
:::

* `-var 'foo=bar'` Set the input variables of the root module. The option can be used multiple times to set several variables.

* `-var-file=filename` Set the path to the file with variables values in addition to the default files terraform.tfvars and *.auto.tfvars.
The option can be used multiple times to specify several files.

* `-json` Set for test outputs to be formatted as JSON.

* `-no-color` Disable color codes in the command output.

* `-verbose` Print the plan or state for each test run block as it executes.

## Usage examples

### Flat structure

**GIVEN** the following OpenTofu module structure:

```commandline
.
├── LICENSE
├── README.md
├── main.tf
├── main.tftest.hcl
├── foo.tf
├── foo.tftest.hcl
├── bar.tf
├── bar.tftest.hcl
├── outputs.tf
└── variables.tf
```

**WHEN** `tofu test` is executed in the project directory,

**THEN** the tests defined in the following files will be run (note that the files are sorted in alphabetical order):

- bar.tftest.hcl,
- foo.tftest.hcl,
- main.tftest.hcl.

**WHEN** `tofu test -filter=foo.tftest.hcl -filter=bar.tftest.hcl` is executed in the project directory,

**THEN** the tests defined in the files `foo.tftest.hcl` and `bar.tftest.hcl` will be run only.

### Nested structure

**GIVEN** the following OpenTofu module structure:

```commandline
.
├── LICENSE
├── README.md
├── main.tf
├── main.tftest.hcl
├── outputs.tf
├── variables.tf
├── tests
│   └── foo.tftest.hcl
└── submodule
    ├── foo.tf
    ├── foo.tftest.hcl
    ├── main.tf
    ├── main.tftest.hcl
    ├── outputs.tf
    ├── variables.tf
    └── tests
        └── foo.tftest.hcl
```

**WHEN** `tofu test` is executed in the project root directory,

**THEN** the tests defined in the following files will be run (note that the files are sorted in alphabetical order):

- main.tftest.hcl,
- tests/foo.tftest.hcl.

**WHEN** `tofu test -test-directory=submodule` is executed in the project root directory,

**THEN** the tests defined in the following files will be run (note that the files are sorted in alphabetical order):

- main.tftest.hcl,
- submodule/foo.tftest.hcl,
- submodule/main.tftest.hcl.

**WHEN** `tofu test -test-directory=submodule -filter=foo.tftest.hcl` is executed in the project root directory,

**THEN** no tests will be run because no test files satisfying filtering criteria will be found.

**WHEN** `tofu test -test-directory=submodule -filter=submodule/foo.tftest.hcl` is executed in the project root directory,

**THEN** the tests defined in the file `submodule/foo.tftest.hcl` will be run only.

## Definition syntax

Tests are defined using three kinds of blocks in the way that every test file

- _shall_ contain _at least one_ `run` block to describe a single testing unit;
- _may_ contain _at most one_ `variables` block to define global variables used by the `runs` defined in the file;
- _may_ contain _multiple_ `provider` blocks to define a provider configuration to be used by the test.

:::info
Note that if a test file contains several `run` blocks, OpenTofu will execute them sequentially from the top to the bottom of the file.
:::

<!--
    /internal/command/testing/test_provider.go:
    provider:
        data_prefix: string
        resource_prefix: string
        alias: string
        version: string
    test_resource:
        id: string
        value: string
        interrupt_count: number
    test_data_source:
        id: string
        value: string
        interrupt_count: number
-->

### `run` block

<!--
    details in /internal/configs/test_file.go:239 decodeTestRunBlock
-->

The following non-mutually exclusive blocks and attributes can be defined within the scope of a single `run` block.

| Name              | Type   | Multiple allowed | Description                                                                                                                                                                            |
|:------------------|:-------|:-----------------|:---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `assert`          | block  | true             | Defines test checks criteria.                                                                                                                                                          |
| `variables`       | block  | false            | Defines local variables as a series of `<KEY> = <VALUE>` (see [details](/docs/language/expressions/types/#mapsobjects)). These values will be used within the scope of the `run` only. |
| `module`          | block  | false            | Defines module to use for the tests defined in the current `*.tftest.hcl` file.                                                                                                        |
| `command`         | string | false            | Defines which command will be executed in the scope of the `run` block, _plan_ or _apply_. Defaults to _apply_.                                                                        |
| `plan_options`    | block  | false            | Defines the of `tofu plan` execution options.                                                                                                                                          |
| `providers`       | object | false            | Used to "mock" providers.                                                                                                                                                              |
| `expect_failures` | list   | false            | Defines a list of resources, or values for which the test `run` is expected to fail.                                                                                                   |

### `run.assert`

The `assert` block requires two attributes:

- `condition`: assertion criteria as a boolean expression.
- `error_message`: assertion message which will be printed if the test fails.

```hcl
run "test" {
  variables {
    want_attr0 = "test-value"
    want_attr1 = 1
  }

  assert {
    condition     = resource_type.resource_name.attr0 == var.want_attr0
    error_message = "failed validation of attr0"
  }

  assert {
    condition     = resource_type.resource_name.attr1 == var.want_attr1
    error_message = "failed validation of attr1"
  }
}
```

:::info
Note that if you would combine several assertions in a single `run` and some of them failed, the total numer of failed tests will be reported as 1.
The opposite is also true, 1 will be reported if all checks are successful.
:::

### `run.module`

The `module` block is defined by two attributes:

- `source` (required): module [source](/docs/language/modules/sources).
- `version` (optional): module version.

```hcl
run "setup-module" {
  module {
    source = "./modules/my_module"
  }
}
```

### `run.plan_options`

The `plan_options` block is defined by the following optional attributes.

| Name    | Type   | Default | Description                                                           |
|:--------|:-------|:--------|:----------------------------------------------------------------------|
| mode    | string | normal  | The planning mode to run. Allowed values: _normal_ or _refresh-only_. |
| refresh | bool   | true    | Analog to `tofu plan -refresh`.                                       |
| replace | list   | null    | Analog to `tofu plan -refresh=ADDRESS`.                               |
| target  | list   | null    | Analog to `tofu plan -target=ADDRESS`.                                |


:::warning
If the `mode` is set to _refresh-only_, the `refresh` parameter cannot be set to _false_.
:::


### `run.providers`

The `providers` object allows to mock providers for execution of the `run`.

TBD

### `run.expect_failures`

The `expect_failures` lists the resources, or variable which are expected to fail during the test.

```hcl
run "unhappy-path" {
  variable {
    input0 = "faulty-input"
  }
  expect_failures = [
    # we expect the module to validate the input
    input.input0,
  ]
}
```

## Variables

Tests can be defined using variables specified in several ways.

The variables will be loaded in the following order, with later sources taking precedence over earlier ones:

1. Environment variables with the prefix `TF_VAR_`;
2. tfvar files specified: `terraform.tfvars` and `*.auto.tfvars`;
3. Commandline variables defined using the flag `-var`, and the variables defined in the files specified by the flag `-var-file`;
4. _Global_ variables from the `variables` block in test file;
5. _Local_ variables from the `variables` block in `run` block.

:::info
The variable value defined by the flags `-var` and `-var-file` will depend on their order: the latest found value will be used.

For example, **given** that the file `test.tfvars` contains the value `my_var="bar"`,
**when** `tofu test -var=my_var="foo" -var-file=test.tfvars -var=my_var="qux"` is executed,
**then** the variable `my_var` will be assigned the value `"qux"`.
:::

## Definition examples

TBD
